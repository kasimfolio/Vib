// ApplyTopLeftFromJSON.jsx

// JSON polyfill for ExtendScript
if (typeof JSON === "undefined") {
    JSON = {};
}

(function () {
    function f(n) {
        return n < 10 ? '0' + n : n;
    }

    if (typeof JSON.stringify !== "function") {
        JSON.stringify = function (obj) {
            var t = typeof obj;
            if (t !== "object" || obj === null) {
                if (t === "string") obj = '"' + obj + '"';
                return String(obj);
            } else {
                var json = [], isArray = (obj && obj.constructor === Array);
                for (var key in obj) {
                    var value = obj[key];
                    var type = typeof value;
                    if (type === "string") value = '"' + value + '"';
                    else if (type === "object" && value !== null) value = JSON.stringify(value);
                    json.push((isArray ? "" : '"' + key + '":') + String(value));
                }
                return (isArray ? "[" : "{") + String(json) + (isArray ? "]" : "}");
            }
        };
    }

    if (typeof JSON.parse !== "function") {
        JSON.parse = function (s) {
            return eval('(' + s + ')');
        };
    }
})();

if (app.documents.length === 0) {
    alert("No document open.");
} else if (app.selection.length !== 1) {
    alert("Please select exactly one object.");
} else {
    var doc = app.activeDocument;
    var sel = app.selection[0];

    var desktopPath = Folder.desktop.fsName;
    var file = new File(desktopPath + "/selectedObjectPosition.json");
    if (!file.exists) {
        alert("JSON file 'selectedObjectPosition.json' not found on desktop.");
    } else {
        if (file.open("r")) {
            var jsonString = file.read();
            file.close();

            try {
                var positionData = JSON.parse(jsonString);

                var savedArtboardIndex = positionData.artboardIndex;
                var savedPos = positionData.topLeft;

                if (savedArtboardIndex < 0 || savedArtboardIndex >= doc.artboards.length) {
                    alert("Saved artboard index is out of range.");
                }

                var artboard = doc.artboards[savedArtboardIndex];
                var abBounds = artboard.artboardRect;
                var abLeft = abBounds[0];
                var abTop = abBounds[1];

                var bounds = sel.visibleBounds;
                var left = bounds[0];
                var top = bounds[1];

                var currRelX = left - abLeft;
                var currRelY = abTop - top;

                var deltaX = savedPos.x - currRelX;
                var deltaY = -(savedPos.y - currRelY);

                sel.translate(deltaX, deltaY);

                doc.artboards.setActiveArtboardIndex(savedArtboardIndex);

                alert("Object moved to saved top-left position relative to artboard.");

            } catch (e) {
                alert("Error parsing JSON file: " + e);
            }
        } else {
            alert("Failed to open JSON file.");
        }
    }
}
